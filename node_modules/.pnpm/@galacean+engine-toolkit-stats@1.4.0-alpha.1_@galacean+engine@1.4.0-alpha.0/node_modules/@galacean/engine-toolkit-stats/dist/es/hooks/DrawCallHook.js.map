{"version":3,"file":"DrawCallHook.js","sources":["../../../src/hooks/DrawCallHook.ts"],"sourcesContent":["import { log, errorLog } from \"../log\";\n\n/**\n * @class DrawCallHook\n */\nexport default class DrawCallHook {\n  public drawCall: number = 0;\n  public triangles: number = 0;\n  public lines: number = 0;\n  public points: number = 0;\n  private hooked: boolean;\n  private readonly realDrawElements: any;\n  private readonly realDrawArrays: any;\n  private readonly realDrawElementsInstanced: any;\n  private readonly realDrawArraysInstanced: any;\n  private readonly gl: WebGLRenderingContext | WebGL2RenderingContext;\n\n  constructor(gl: WebGLRenderingContext | WebGL2RenderingContext) {\n    this.realDrawElements = gl.drawElements;\n    this.realDrawArrays = gl.drawArrays;\n\n    gl.drawElements = this.hookedDrawElements.bind(this);\n    gl.drawArrays = this.hookedDrawArrays.bind(this);\n\n    const hasInstancedFunc = this.hasInstancedFunction(gl);\n    if (hasInstancedFunc) {\n      // @ts-ignore\n      this.realDrawElementsInstanced = gl.drawElementsInstanced;\n      // @ts-ignore\n      this.realDrawArraysInstanced = gl.drawArraysInstanced;\n\n      // @ts-ignore\n      gl.drawElementsInstanced = this.hookedDrawElementsInstanced.bind(this);\n      // @ts-ignore\n      gl.drawArraysInstanced = this.hookedDrawArraysInstanced.bind(this);\n    } else {\n      const extAngleInstancedArrays = gl.getExtension(\"ANGLE_instanced_arrays\");\n      if (extAngleInstancedArrays) {\n        this.realDrawElementsInstanced = extAngleInstancedArrays.drawElementsInstancedANGLE;\n        this.realDrawArraysInstanced = extAngleInstancedArrays.drawArraysInstancedANGLE;\n\n        extAngleInstancedArrays.drawElementsInstancedANGLE = this.hookedDrawElementsInstanced.bind(this);\n        extAngleInstancedArrays.drawArraysInstancedANGLE = this.hookedDrawArraysInstanced.bind(this);\n      } else {\n        errorLog(`GPU Instancing is not supported.`);\n      }\n    }\n\n    this.hooked = true;\n    this.gl = gl;\n\n    log(`DrawCall is hooked.`);\n  }\n\n  private hasInstancedFunction(gl: WebGLRenderingContext | WebGL2RenderingContext): boolean {\n    return (gl instanceof WebGL2RenderingContext || ((gl as any).hasOwnProperty(\"drawElementsInstanced\") && (gl as any).hasOwnProperty(\"drawArraysInstanced\")));\n  }\n\n  private hookedDrawElements(mode: number, count: number, type: number, offset: number): void {\n    this.realDrawElements.call(this.gl, mode, count, type, offset);\n    this.update(count, mode);\n  }\n\n  private hookedDrawArrays(mode: number, first: number, count: number): void {\n    this.realDrawArrays.call(this.gl, mode, first, count);\n    this.update(count, mode);\n  }\n\n  private hookedDrawElementsInstanced(mode: number, count: number, type: number, offset: number, primcount: number): void {\n    this.realDrawElementsInstanced.call(this.gl, mode, count, type, offset, primcount);\n    this.update(count, mode);\n  }\n\n  private hookedDrawArraysInstanced(mode: number, first: number, count: number, primcount: number): void {\n    this.realDrawArraysInstanced.call(this.gl, mode, first, count, primcount);\n    this.update(count, mode);\n  }\n\n  private update(count: number, mode: number): void {\n    const { gl } = this;\n\n    this.drawCall++;\n\n    switch (mode) {\n      case gl.TRIANGLES:\n        this.triangles += count / 3;\n        break;\n\n      case gl.TRIANGLE_STRIP:\n      case gl.TRIANGLE_FAN:\n        this.triangles += count - 2;\n        break;\n\n      case gl.LINES:\n        this.lines += count / 2;\n        break;\n\n      case gl.LINE_STRIP:\n        this.lines += count - 1;\n        break;\n\n      case gl.LINE_LOOP:\n        this.lines += count;\n        break;\n\n      case gl.POINTS:\n        this.points += count;\n        break;\n\n      default:\n        errorLog(`Unknown draw mode: ${mode}`);\n        break;\n    }\n  }\n\n  public reset(): void {\n    this.drawCall = 0;\n    this.triangles = 0;\n    this.lines = 0;\n    this.points = 0;\n  }\n\n  public release(): void {\n    if (this.hooked) {\n      const { gl } = this;\n      gl.drawElements = this.realDrawElements;\n      gl.drawArrays = this.realDrawArrays;\n\n      const hasInstancedFunc = this.hasInstancedFunction(gl);\n      if (hasInstancedFunc) {\n        // @ts-ignore\n        gl.drawElementsInstanced = this.realDrawElementsInstanced;\n        // @ts-ignore\n        gl.drawArraysInstanced = this.realDrawArraysInstanced;\n      } else {\n        const extAngleInstancedArrays = gl.getExtension(\"ANGLE_instanced_arrays\");\n        if (extAngleInstancedArrays) {\n          extAngleInstancedArrays.drawElementsInstancedANGLE = this.realDrawElementsInstanced;\n          extAngleInstancedArrays.drawArraysInstancedANGLE = this.realDrawArraysInstanced;\n        }\n      }\n    }\n\n    this.hooked = false;\n  }\n}\n"],"names":["DrawCallHook","gl","drawCall","triangles","lines","points","realDrawElements","drawElements","realDrawArrays","drawArrays","hookedDrawElements","bind","hookedDrawArrays","hasInstancedFunc","hasInstancedFunction","realDrawElementsInstanced","drawElementsInstanced","realDrawArraysInstanced","drawArraysInstanced","hookedDrawElementsInstanced","hookedDrawArraysInstanced","extAngleInstancedArrays","getExtension","drawElementsInstancedANGLE","drawArraysInstancedANGLE","errorLog","hooked","log","WebGL2RenderingContext","hasOwnProperty","mode","count","type","offset","call","update","first","primcount","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN","LINES","LINE_STRIP","LINE_LOOP","POINTS","reset","release"],"mappings":"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"}